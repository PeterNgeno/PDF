<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>KCSE & Course PDFs</title>

<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

<style>
body {
  font-family: Georgia, serif;
  background: #f2f2f2;
  margin: 0;
}

/* ===== LAYOUT ===== */
.container {
  display: flex;
  min-height: 100vh;
}

/* ===== SIDEBAR ===== */
.sidebar {
  width: 300px;
  background: #111;
  color: #fff;
  padding: 20px;
}

.sidebar h2 {
  font-size: 18px;
  margin-bottom: 15px;
}

.sheet-title {
  cursor: pointer;
  padding: 10px;
  background: #222;
  margin-bottom: 8px;
  border-left: 4px solid transparent;
}

.sheet-title:hover,
.sheet-title.active {
  background: #333;
  border-left: 4px solid #00b894;
}

/* ===== MAIN CONTENT ===== */
.main {
  flex: 1;
  padding: 30px;
}

.download-btn {
  background: #00b894;
  color: white;
  padding: 10px 18px;
  border: none;
  cursor: pointer;
  font-size: 14px;
  margin-bottom: 15px;
}

/* ===== PDF MAGAZINE ===== */
.magazine {
  background: white;
  max-width: 210mm;
  padding: 30px;
  margin: auto;
  position: relative;
}

/* IMAGE WATERMARK */
.magazine::before {
  content: "";
  position: fixed;
  inset: 0;
  background: url("peron.png") repeat;
  background-size: 180px;
  opacity: 0.05;
  transform: rotate(-25deg);
}

/* TEXT WATERMARK */
.watermark-text {
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%) rotate(-30deg);
  font-size: 46px;
  color: rgba(0,0,0,0.08);
  font-weight: bold;
  pointer-events: none;
}

.content {
  position: relative;
  z-index: 2;
}

/* HEADER */
.header {
  text-align: center;
  border-bottom: 3px solid #000;
  margin-bottom: 30px;
}

.header h1 {
  margin: 0;
  font-size: 28px;
}

.header p {
  font-size: 14px;
  color: #444;
}

/* QUESTIONS */
.question {
  margin-bottom: 25px;
  page-break-inside: avoid;
}

.question-number {
  font-weight: bold;
}

.diagram img {
  max-width: 100%;
  border: 1px solid #ccc;
  margin-top: 10px;
}
</style>
</head>

<body>

<div class="container">

  <!-- SIDEBAR -->
  <div class="sidebar">
    <h2>Available Papers</h2>
    <div id="sheetList"></div>
  </div>

  <!-- MAIN -->
  <div class="main">
    <button class="download-btn" onclick="downloadPDF()">Download PDF</button>

    <div class="magazine" id="pdfArea">
      <div class="watermark-text">www.perontips.co.ke</div>

      <div class="content">
        <div class="header">
          <h1 id="paperTitle">Select a Paper</h1>
          <p id="paperType"></p>
        </div>

        <div id="questions"></div>
      </div>
    </div>
  </div>

</div>

<script>
/* ===== CONFIG ===== */

const SHEET_ID = "1X8XY51OIVpMX5BMsnnsEpuuYsdvRsnSxbmWFbidbTBs";

/* DEFINE SHEETS HERE */
const SHEETS = [
  "Sheet1",
  "Sheet3",
  "Sheet4"
];

let currentSheet = "";

/* ===== LOAD TITLES ===== */

const sheetList = document.getElementById("sheetList");

SHEETS.forEach(sheet => {
  const div = document.createElement("div");
  div.className = "sheet-title";
  div.innerText = sheet;
  div.onclick = () => loadSheet(sheet, div);
  sheetList.appendChild(div);
});

/* ===== LOAD SHEET CONTENT ===== */

async function loadSheet(sheetName, el) {
  document.querySelectorAll(".sheet-title").forEach(s => s.classList.remove("active"));
  el.classList.add("active");

  currentSheet = sheetName;

  const url = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:csv&sheet=${sheetName}`;
  const csv = await fetch(url).then(r => r.text());
  const rows = csv.split("\n").map(r => r.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/));

  /* FIRST ROW = TYPE */
  const paperType = rows[0][0].replace(/"/g, "");
  document.getElementById("paperType").innerText = paperType;
  document.getElementById("paperTitle").innerText = sheetName;

  const container = document.getElementById("questions");
  container.innerHTML = "";

  rows.slice(1).forEach((cols, i) => {
    const q = cols[0]?.replace(/"/g, "");
    const img = cols[1]?.replace(/"/g, "");

    if (!q) return;

    container.innerHTML += `
      <div class="question">
        <div class="question-number">Question ${i + 1}</div>
        <div>${q}</div>
        ${img ? `<div class="diagram"><img src="${img}"></div>` : ""}
      </div>
    `;
  });
}

/* ===== DOWNLOAD PDF ===== */

function downloadPDF() {
  if (!currentSheet) {
    alert("Please select a paper first");
    return;
  }

  html2pdf().set({
    filename: currentSheet + ".pdf",
    html2canvas: { scale: 2, useCORS: true },
    jsPDF: { format: "a4", orientation: "portrait" }
  }).from(document.getElementById("pdfArea")).save();
}
</script>

</body>
</html>
