<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>PDF Viewer</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
<style>
body {font-family: Georgia, serif; background:#f4f4f4; margin:0; padding:20px;}
#pdf-content {max-width:900px; margin:auto; background:#fff; padding:40px; border-radius:12px; box-shadow:0 8px 30px rgba(0,0,0,0.2);}
h1 {display: inline-block; text-align:center; color:#fff; font-size:36px; margin-bottom:20px; background: linear-gradient(135deg,#003366,#00b894); padding:20px 30px; border-radius:12px; box-shadow: 0 5px 15px rgba(0,0,0,0.2); word-break: break-word;}
.separator {width:100%; height:4px; background: linear-gradient(to right, #00b894, #003366); margin:30px 0; border-radius:2px;}
.song img {width:100%; max-height:350px; object-fit:cover; border-radius:12px; box-shadow:0 5px 15px rgba(0,0,0,0.15); margin-bottom:20px;}
.song p {white-space:pre-wrap; line-height:1.7; font-size:18px; color:#222; margin-bottom:20px;}
.song iframe {width:100%; height:360px; border-radius:12px; margin-bottom:20px; box-shadow:0 5px 15px rgba(0,0,0,0.15); border:0;}
.watermark-text {position:absolute; top:10px; right:10px; font-size:18px; color:rgba(0,0,0,0.15);}
.watermark-img {position:absolute; bottom:10px; right:10px; width:80px; opacity:0.1;}
.download-btn {display:block; margin:30px auto; padding:15px 25px; background:#00b894; color:#fff; font-size:18px; border:none; border-radius:8px; cursor:pointer; box-shadow: 0 5px 15px rgba(0,0,0,0.2); transition:0.3s;}
.download-btn:hover {background:#00976a; box-shadow: 0 8px 20px rgba(0,0,0,0.3);}
</style>
</head>
<body>

<div id="pdf-content">
<h1 id="pdf-title"></h1>
<div class="separator"></div>
<div id="sheet-content"></div>
</div>

<button class="download-btn" id="downloadBtn">Download PDF</button>

<script>
const params = new URLSearchParams(window.location.search);
const rowIndex = parseInt(params.get("row")) || 0;
const sheetName = params.get("sheet") || "Sheet1";
const pdfTitle = params.get("title") || "Document";
document.getElementById("pdf-title").textContent = pdfTitle;

const sheetURL = `https://docs.google.com/spreadsheets/d/1X8XY51OIVpMX5BMsnnsEpuuYsdvRsnSxbmWFbidbTBs/gviz/tq?tqx=out:json&sheet=${sheetName}`;
const sheetContentDiv = document.getElementById("sheet-content");

fetch(sheetURL)
.then(res => res.text())
.then(data => {
    const json = JSON.parse(data.substring(47, data.length-2));
    const row = json.table.rows[rowIndex]?.c || [];
    if(!row || row.length === 0){
        sheetContentDiv.innerHTML = "<p>No content available for this PDF.</p>";
        return;
    }

    const title = row[0]?.v || "Untitled";
    const notes = row[1]?.v || "";
    const image = row[2]?.v || "";

    const songDiv = document.createElement("div");
    songDiv.className = "song";

    if(image){
        const img = document.createElement("img");
        img.src = image;
        songDiv.appendChild(img);
    }

    if(notes){
        const p = document.createElement("p");
        p.textContent = notes;
        songDiv.appendChild(p);
    }

    // Watermarks
    const wmText = document.createElement("div");
    wmText.className = "watermark-text";
    wmText.textContent = "www.perontips.co.ke";
    songDiv.appendChild(wmText);

    const wmImg = document.createElement("img");
    wmImg.src = "peron.png";
    wmImg.className = "watermark-img";
    songDiv.appendChild(wmImg);

    sheetContentDiv.appendChild(songDiv);
});

// Download PDF button
document.getElementById("downloadBtn").addEventListener("click", ()=>{
    html2pdf().set({
        margin:0.3,
        filename: pdfTitle+".pdf",
        image: {type:'jpeg', quality:0.98},
        html2canvas: {scale:2},
        jsPDF: {unit:'in', format:'a4', orientation:'portrait'}
    }).from(document.getElementById("pdf-content")).save();
});
</script>

</body>
</html>
