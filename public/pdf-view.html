<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>PDF Viewer</title>
<script>
const params = new URLSearchParams(window.location.search);
const sheetName = params.get("sheet");

if (!sheetName) {
  document.getElementById("loader").textContent = "Invalid document.";
  throw new Error("No sheet specified");
}

const spreadsheetId = "1X8XY51OIVpMX5BMsnnsEpuuYsdvRsnSxbmWFbidbTBs";
const sheetURL = `https://docs.google.com/spreadsheets/d/${spreadsheetId}/gviz/tq?tqx=out:json&sheet=${encodeURIComponent(sheetName)}`;

const contentDiv = document.getElementById("pdf-content");
const loader = document.getElementById("loader");
const tocList = document.getElementById("toc-list");
const titleEl = document.getElementById("pdf-title");

let allRows = [];
let batch = 4;
let currentIndex = 1; // start AFTER title row (A1)

// Build section
function createSection(row, index) {
  const c = row.c;
  const sectionTitle = c[0]?.v;
  if (!sectionTitle) return null;

  const text = c[1]?.v || "";
  const image = c[2]?.v || "";
  const youtube = c[3]?.v || "";
  const source = c[4]?.v || "#";

  const section = document.createElement("div");
  section.className = "song";
  section.id = `sec-${index}`;

  // TOC
  const tocLi = document.createElement("li");
  tocLi.innerHTML = `<a href="#sec-${index}">${sectionTitle}</a>`;
  tocList.appendChild(tocLi);

  // Title
  const h2 = document.createElement("h2");
  const a = document.createElement("a");
  a.textContent = sectionTitle;
  a.href = source;
  a.target = "_blank";
  h2.appendChild(a);
  section.appendChild(h2);

  if (image) {
    const img = document.createElement("img");
    img.src = image;
    section.appendChild(img);
  }

  if (text) {
    const p = document.createElement("p");
    p.textContent = text;
    section.appendChild(p);
  }

  if (youtube) {
    const id = youtube.includes("v=")
      ? youtube.split("v=")[1].split("&")[0]
      : youtube.split("be/")[1];
    const iframe = document.createElement("iframe");
    iframe.src = `https://www.youtube.com/embed/${id}`;
    iframe.allowFullscreen = true;
    section.appendChild(iframe);
  }

  section.innerHTML += `
    <div class="watermark-text">www.perontips.co.ke</div>
    <img src="peron.png" class="watermark-img">
  `;

  return section;
}

// Render sections in batches
function renderBatch() {
  const end = Math.min(currentIndex + batch, allRows.length);
  for (let i = currentIndex; i < end; i++) {
    const sec = createSection(allRows[i], i);
    if (sec) contentDiv.appendChild(sec);
  }
  currentIndex = end;

  if (currentIndex >= allRows.length) {
    loader.style.display = "none";
    window.removeEventListener("scroll", scrollHandler);
  }
}

function scrollHandler() {
  if (window.innerHeight + window.scrollY >= document.body.offsetHeight - 80) {
    renderBatch();
  }
}

// Fetch data
fetch(sheetURL)
  .then(res => res.text())
  .then(text => {
    const json = JSON.parse(text.substring(47, text.length - 2));
    allRows = json.table.rows || [];

    // A1 = PDF title
    const pdfTitle = allRows[0]?.c?.[0]?.v || "Document";
    titleEl.textContent = pdfTitle;
    document.title = pdfTitle + " | perontips.co.ke";

    renderBatch();
    window.addEventListener("scroll", scrollHandler);
  })
  .catch(err => {
    loader.textContent = "Failed to load document.";
    console.error(err);
  });

// Download PDF
document.getElementById("downloadBtn").addEventListener("click", () => {
  html2pdf().set({
    margin: 0.3,
    filename: document.title + ".pdf",
    image: { type: "jpeg", quality: 0.98 },
    html2canvas: { scale: 2 },
    jsPDF: { unit: "in", format: "a4", orientation: "portrait" }
  }).from(contentDiv).save();
});
</script>
const params = new URLSearchParams(window.location.search);
const sheetName = params.get("sheet");
const pdfTitle = params.get("title") || "Document";
document.getElementById("pdf-title").textContent = pdfTitle;

const sheetURL = `https://docs.google.com/spreadsheets/d/1X8XY51OIVpMX5BMsnnsEpuuYsdvRsnSxbmWFbidbTBs/gviz/tq?tqx=out:json&sheet=${sheetName}`;
const contentDiv = document.getElementById("pdf-content");
const loader = document.getElementById("loader");
const tocList = document.getElementById("toc-list");

let allRows = [];
let batch = 5;  // rows per scroll
let currentIndex = 0;

// Create song element from row
function createSong(row, index){
  const cells = row.c;
  const title = cells[0]?.v || "";
  if (!title.trim()) return null;
  const lyrics = cells[1]?.v || "";
  const image = cells[2]?.v || "";
  const youtube = cells[3]?.v || "";
  const sourceLink = cells[4]?.v || "#";

  const songDiv = document.createElement("div");
  songDiv.className = "song";
  songDiv.id = `song-${index}`;

  // TOC link
  const tocLi = document.createElement("li");
  const tocA = document.createElement("a");
  tocA.href = `#song-${index}`;
  tocA.textContent = title;
  tocLi.appendChild(tocA);
  tocList.appendChild(tocLi);

  // Title as link
  const h2 = document.createElement("h2");
  const a = document.createElement("a");
  a.href = sourceLink;
  a.textContent = title;
  a.target = "_blank";
  h2.appendChild(a);
  songDiv.appendChild(h2);

  if(image){
    const img = document.createElement("img");
    img.src = image;
    songDiv.appendChild(img);
  }

  if(lyrics){
    const p = document.createElement("p");
    p.textContent = lyrics;
    songDiv.appendChild(p);
  }

  if(youtube){
    const ytId = youtube.includes("v=") ? youtube.split("v=")[1] : youtube.split(".be/")[1];
    const iframe = document.createElement("iframe");
    iframe.src = `https://www.youtube.com/embed/${ytId}`;
    iframe.allowFullscreen = true;
    songDiv.appendChild(iframe);
  }

  const wmText = document.createElement("div");
  wmText.className = "watermark-text";
  wmText.textContent = "www.perontips.co.ke";
  songDiv.appendChild(wmText);

  const wmImg = document.createElement("img");
  wmImg.src = "peron.png";
  wmImg.className = "watermark-img";
  songDiv.appendChild(wmImg);

  return songDiv;
}

// Render batch
function renderBatch(){
  const end = Math.min(currentIndex + batch, allRows.length);
  for(let i = currentIndex; i < end; i++){
    const songDiv = createSong(allRows[i], i+1);
    if(songDiv) contentDiv.appendChild(songDiv);
  }
  currentIndex = end;
  if(currentIndex >= allRows.length){
    loader.style.display = "none";
    window.removeEventListener("scroll", scrollHandler);
  }
}

// Scroll handler
function scrollHandler(){
  if(window.innerHeight + window.scrollY >= document.body.offsetHeight - 50){
    renderBatch();
  }
}

// Fetch sheet
fetch(sheetURL)
.then(res => res.text())
.then(data => {
  const json = JSON.parse(data.substring(47, data.length-2));
  allRows = json.table.rows || [];
  renderBatch();
  window.addEventListener("scroll", scrollHandler);
})
.catch(err => {
  loader.textContent = "Error loading content.";
  console.error(err);
});

// Download PDF
document.getElementById("downloadBtn").addEventListener("click", ()=>{
  html2pdf().set({
    margin:0.3,
    filename: pdfTitle + ".pdf",
    image: {type:'jpeg', quality:0.98},
    html2canvas: {scale:2},
    jsPDF: {unit:'in', format:'a4', orientation:'portrait'}
  }).from(contentDiv).save();
});
</script>

</body>
</html>
