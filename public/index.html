<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>KCSE & Courses PDF Library</title>

<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

<style>
body{
  margin:0;
  font-family:Georgia, serif;
  background:#f4f4f4;
}

.page{
  max-width:1100px;
  margin:auto;
  padding:25px;
}

h1{margin-top:0}

.search{
  width:100%;
  padding:12px;
  font-size:16px;
  margin-bottom:20px;
}

.title-link{
  background:#fff;
  padding:18px;
  margin-bottom:14px;
  font-size:20px;
  font-weight:bold;
  cursor:pointer;
  border-left:6px solid #00b894;
  box-shadow:0 2px 6px rgba(0,0,0,.08);
}

.title-link:hover{
  background:#f0fff8;
}

.title-link.active{
  border-left-color:#0984e3;
}

.download-btn{
  display:none;
  background:#00b894;
  color:white;
  border:none;
  padding:14px 22px;
  font-size:15px;
  cursor:pointer;
  margin:25px 0;
}

#pdfArea{
  display:none;
  background:white;
  padding:30px;
  max-width:210mm;
  margin:auto;
  position:relative;
}

#pdfArea::before{
  content:"";
  position:fixed;
  inset:0;
  background:url("peron.png") repeat;
  background-size:180px;
  opacity:.05;
  transform:rotate(-25deg);
}

.watermark{
  position:fixed;
  top:50%;
  left:50%;
  transform:translate(-50%,-50%) rotate(-30deg);
  font-size:46px;
  font-weight:bold;
  color:rgba(0,0,0,.08);
  pointer-events:none;
}

.content{position:relative;z-index:2}

.pdf-title{
  font-size:32px;
  font-weight:bold;
  text-align:center;
  margin-bottom:30px;
  border-bottom:3px solid #000;
  padding-bottom:12px;
}

.question{
  margin-bottom:25px;
  page-break-inside:avoid;
}

.diagram img{
  max-width:100%;
  margin-top:10px;
  border:1px solid #ccc;
}
</style>
</head>

<body>

<div class="page">

<h1>Available KCSE Papers & Courses</h1>

<input class="search" placeholder="Search papers or courses..." onkeyup="filterTitles(this.value)">

<div id="titleList"></div>

<button class="download-btn" id="downloadBtn">Download PDF</button>

<div id="pdfArea">
  <div class="watermark">www.perontips.co.ke</div>
  <div class="content">
    <div class="pdf-title" id="pdfTitle"></div>
    <div id="questions"></div>
  </div>
</div>

</div>

<script>
/* ===== CONFIG ===== */
const INDEX_CSV =
"https://docs.google.com/spreadsheets/d/e/2PACX-1vRO8naTtvq63fZm0cNQdzwl6R5KL6UQD06EHcwiGemkvvJ4JhdK_M6wtoQPQZQDFiIyQJ894pzNpNVj/pub?output=csv";

let currentTitle = "";
let currentPDFLink = "";

/* ===== LOAD TITLES ===== */
async function loadTitles(){
  const res = await fetch(INDEX_CSV);
  const text = await res.text();
  const rows = text.trim().split("\n");

  const list = document.getElementById("titleList");
  list.innerHTML = "";

  rows.forEach(row=>{
    if(!row) return;

    const cols = row.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/);
    const title = cols[0]?.replace(/"/g,"").trim();
    const link  = cols[1]?.replace(/"/g,"").trim();

    if(!title || !link) return;

    const div = document.createElement("div");
    div.className = "title-link";
    div.textContent = title;

    // PDF LINK
    if(link.startsWith("http")){
      div.onclick = ()=>{
        currentTitle = title;
        currentPDFLink = link;

        document.getElementById("pdfArea").style.display = "none";
        document.getElementById("downloadBtn").style.display = "inline-block";

        window.open(link, "_blank");

        document.getElementById("downloadBtn").onclick = ()=>{
          window.open(link.replace("/view","/uc?export=download"), "_blank");
        };
      };
    }
    // SHEET CONTENT
    else{
      div.onclick = ()=>loadSheetPDF(link,title,div);
    }

    list.appendChild(div);
  });
}

/* ===== LOAD QUESTIONS FROM SHEET ===== */
async function loadSheetPDF(sheet,title,el){
  document.querySelectorAll(".title-link").forEach(d=>d.classList.remove("active"));
  el.classList.add("active");

  document.getElementById("pdfArea").style.display="block";
  document.getElementById("downloadBtn").style.display="inline-block";

  currentTitle = title;
  document.getElementById("pdfTitle").innerText = title;

  const url =
  `https://docs.google.com/spreadsheets/d/e/2PACX-1vRO8naTtvq63fZm0cNQdzwl6R5KL6UQD06EHcwiGemkvvJ4JhdK_M6wtoQPQZQDFiIyQJ894pzNpNVj/pub?output=csv&sheet=${sheet}`;

  const csv = await fetch(url).then(r=>r.text());
  const rows = csv.trim().split("\n");

  const qDiv = document.getElementById("questions");
  qDiv.innerHTML = "";

  rows.forEach((row,i)=>{
    const cols = row.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/);
    const q = cols[0]?.replace(/"/g,"").trim();
    const img = cols[1]?.replace(/"/g,"").trim();
    if(!q) return;

    qDiv.innerHTML += `
    <div class="question">
      <strong>Question ${i+1}</strong><br>
      ${q}
      ${img?`<div class="diagram"><img src="${img}"></div>`:""}
    </div>`;
  });

  document.getElementById("downloadBtn").onclick = downloadGeneratedPDF;
}

/* ===== SEARCH ===== */
function filterTitles(text){
  document.querySelectorAll(".title-link").forEach(d=>{
    d.style.display =
      d.textContent.toLowerCase().includes(text.toLowerCase())
      ? "block" : "none";
  });
}

/* ===== DOWNLOAD GENERATED PDF ===== */
function downloadGeneratedPDF(){
  html2pdf().set({
    filename: currentTitle+".pdf",
    html2canvas:{scale:2,useCORS:true},
    jsPDF:{format:"a4",orientation:"portrait"}
  }).from(document.getElementById("pdfArea")).save();
}

/* START */
loadTitles();
</script>

</body>
</html>
